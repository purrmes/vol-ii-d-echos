# Production Docker Swarm Configuration for NPP WordPress
# -----------------------------------------------------------
# Deployment Notes:
# - Deploy with: docker stack deploy -c docker-compose.yml npp
# - All development features have been removed
# - Update all passwords and secrets in .env before deployment
# - Set NPP_HTTP_HOST to your actual domain name
# - Images must be pre-built and pushed to registry before deployment
# - Build images with: docker compose build && docker compose push
# - Review resource limits based on your cluster capacity
# -----------------------------------------------------------

version: '3.8'

services:
  wordpress:
    image: ghcr.io/psaux-it/wordpress-nginx-cache-docker/wordpress:latest
    env_file:
      - .env
    volumes:
      - ${WORDPRESS_HOME}:${NPP_WEB_ROOT_}
      - ${NGINX_CACHE}:${NPP_NGINX_CACHE_PATH_}
      - ${NGINX_CONF}:/etc/nginx/nginx.conf
      - ${NPP_NGINX_CONF}:/etc/nginx/conf.d/default.conf
      - ${NPP_FPM_CONF}:/usr/local/etc/php-fpm.d/www.conf
      - ${FPM_DOCKER_CONF}:/usr/local/etc/php-fpm.d/zz-docker.conf
      - ${NPP_PHP_CONF}:/usr/local/etc/php/conf.d/npp.ini
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    environment:
      - WORDPRESS_DB_HOST=${WORDPRESS_DB_HOST}
      - WORDPRESS_DB_USER=${WORDPRESS_DB_USER}
      - WORDPRESS_DB_PASSWORD=${WORDPRESS_DB_PASSWORD}
      - WORDPRESS_DB_NAME=${WORDPRESS_DB_NAME}
      - WORDPRESS_TABLE_PREFIX=${WORDPRESS_TABLE_PREFIX}
      - REDIS_HOST=${VALKEY_HOST}
      - REDIS_PORT=${VALKEY_PORT}
      - REDIS_PASSWORD=${VALKEY_PASSWORD}
      - REDIS_DATABASE=${VALKEY_DATABASE}
      - WP_REDIS_HOST=${VALKEY_HOST}
      - WP_REDIS_PORT=${VALKEY_PORT}
      - WP_REDIS_PASSWORD=${VALKEY_PASSWORD}
      - WP_REDIS_DATABASE=${VALKEY_DATABASE}
      - WP_CACHE_KEY_SALT=${NPP_HTTP_HOST}
      - WORDPRESS_CONFIG_EXTRA=
          define('FORCE_SSL_ADMIN', true);
          define('FORCE_SSL_LOGIN', true);
          if (defined('WP_CLI') && WP_CLI && !isset($$_SERVER['HTTP_HOST'])) $$_SERVER['HTTP_HOST'] = "${NPP_HTTP_HOST}";
      - NPP_WEB_ROOT=${NPP_WEB_ROOT_}
      - NPP_NGINX_CACHE_PATH=${NPP_NGINX_CACHE_PATH_}
      - NPP_HTTP_HOST=${NPP_HTTP_HOST}
      - NPP_USER=${NPP_USER_}
      - NPP_UID=${NPP_UID_}
      - NPP_GID=${NPP_GID_}
      - WORDPRESS_SITE_URL=${WORDPRESS_SITE_URL_}
      - WORDPRESS_SITE_TITLE=${WORDPRESS_SITE_TITLE_}
      - WORDPRESS_ADMIN_USER=${WORDPRESS_ADMIN_USER_}
      - WORDPRESS_ADMIN_PASSWORD=${WORDPRESS_ADMIN_PASSWORD_}
      - WORDPRESS_ADMIN_EMAIL=${WORDPRESS_ADMIN_EMAIL_}
    networks:
      - npp_network
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 3
        window: 120s
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: stop-first
      rollback_config:
        parallelism: 1
        delay: 5s
        failure_action: pause
        order: stop-first
      resources:
        limits:
          cpus: "1.0"
          memory: "2GB"
        reservations:
          cpus: "1.0"
          memory: "1GB"

  nginx:
    image: ghcr.io/psaux-it/wordpress-nginx-cache-docker/nginx:latest
    env_file:
      - .env
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.${TRAEFIK_ROUTER_NAME}.rule=Host(`${NPP_HTTP_HOST}`)"
      - "traefik.http.routers.${TRAEFIK_ROUTER_NAME}.entrypoints=websecure"
      - "traefik.http.routers.${TRAEFIK_ROUTER_NAME}.tls=true"
      - "traefik.http.services.${TRAEFIK_ROUTER_NAME}.loadbalancer.server.port=80"
      # HTTP to HTTPS redirect
      - "traefik.http.routers.${TRAEFIK_ROUTER_NAME}-http.rule=Host(`${NPP_HTTP_HOST}`)"
      - "traefik.http.routers.${TRAEFIK_ROUTER_NAME}-http.entrypoints=web"
      - "traefik.http.routers.${TRAEFIK_ROUTER_NAME}-http.middlewares=redirect-to-https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
    volumes:
      - ${WORDPRESS_HOME}:${NPP_WEB_ROOT_}:ro
      - ${NGINX_CACHE}:${NPP_NGINX_CACHE_PATH_}
      - ${NGINX_CONF}:/etc/nginx/nginx.conf
      - ${NPP_NGINX_CONF}:/etc/nginx/conf.d/default.conf
      - ${NPP_NGINX_PARAMS_CONF}:/etc/nginx/fastcgi_params
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    environment:
      - NPP_WEB_ROOT=${NPP_WEB_ROOT_}
      - NPP_USER=${NPP_USER_}
      - NPP_UID=${NPP_UID_}
      - NPP_GID=${NPP_GID_}
      - NGINX_WEB_USER=${NGINX_WEB_USER_}
      - NPP_HTTP_HOST=${NPP_HTTP_HOST}
    networks:
      - npp_network
      - traefik
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 3
        window: 120s
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 5s
        failure_action: pause
        order: start-first
      resources:
        limits:
          cpus: "1"
          memory: "1.5GB"
        reservations:
          cpus: "0.5"
          memory: "1GB"

volumes:
  wordpress:
  nginx_cache:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=500m

networks:
  npp_network:
    driver: overlay
    attachable: true
    ipam:
      config:
        - subnet: 10.20.0.0/24
  traefik:
    external: true
    name: traefik
